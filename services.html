<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Browse Services – Meridian Services Directory</title>
  <link rel="stylesheet" href="styles.css" />
  <style>
    /* minimal extras kept local to avoid touching styles.css */
    .search-bar { display:flex; gap:12px; flex-wrap:wrap; margin: 16px 0 8px; }
    .search-bar input, .search-bar select { flex:1; min-width:220px; }
    .results-meta { font-size: 0.9rem; color: #555; margin: 6px 0 18px; }
    .service-card { background:#fff; border:1px solid #e5e5e5; border-radius:10px; padding:16px; margin:12px 0; }
    .service-card h3 { margin:0 0 4px; }
    .service-card .meta { color:#385; font-weight:600; margin-bottom:6px; }
    .badge { display:inline-block; padding:2px 8px; border-radius:999px; border:1px solid #cbd5c0; font-size:0.8rem; margin-left:8px; color:#2f5b35; }
    .muted { color:#666; }
    .empty { padding:18px; border:1px dashed #cbd5c0; border-radius:10px; background:#fafdf9; }
  </style>
</head>
<body>
  <main class="container">
    <header class="page-header">
      <h1>Browse Services</h1>
      <p class="lead">Search and connect with neighbors offering their skills and services.</p>
    </header>

    <!-- Search + Filters -->
    <section class="search-section">
      <div class="search-bar">
        <input id="q" type="text" placeholder="Search by name, category, or keywords…" />
        <select id="category">
          <option value="">All categories</option>
        </select>
        <select id="sort">
          <option value="new">Newest first</option>
          <option value="name">Name A–Z</option>
          <option value="category">Category A–Z</option>
        </select>
      </div>
      <div class="results-meta" id="resultsMeta"></div>
    </section>

    <!-- Results -->
    <section id="results" class="services-container"></section>

    <section class="about block">
      <p class="muted">Don't see what you need? <a href="index.html#add-service">Add your service</a> and help the list grow.</p>
    </section>
  </main>

  <!-- Admin link (subtle footer) -->
  <footer style="text-align: center; padding: 20px 0; font-size: 0.8em; color: #999;">
    <a href="admin.html" style="color: inherit; text-decoration: none;">·</a>
  </footer>

  <!-- Supabase SDK -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script>
    // Initialize Supabase client
    const SUPABASE_URL = "https://hpzmzppvfqsgirdxblmh.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imhwem16cHB2ZnFzZ2lyZHhibG1oIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxNTA5MjEsImV4cCI6MjA3MDcyNjkyMX0.b8_jIVUniTjSiZJfQ7HVYqsgmiYyqLL3wVkJWDtN8rs";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // Rest of the code...
    const resultsEl = document.getElementById('results');
    const resultsMetaEl = document.getElementById('resultsMeta');
    const qEl = document.getElementById('q');
    const categoryEl = document.getElementById('category');
    const sortEl = document.getElementById('sort');

    // Fetch all services once, then filter client-side
    let ALL = [];

    function render(list) {
      resultsMetaEl.textContent = list.length
        ? `${list.length} service${list.length === 1 ? '' : 's'}`
        : 'No services found';

      if (!list.length) {
        resultsEl.innerHTML = `
          <div class="empty">Nothing matches yet. Try a different term or
          <a href="index.html#add-service">add your service</a>.</div>`;
        return;
      }

      resultsEl.innerHTML = list.map(s => {
        const price = s.price ? `<span class="badge">${escapeHtml(s.price)}</span>` : '';
        return `
          <div class="service-card">
            <h3>${escapeHtml(s.name)}</h3>
            <div class="meta">${escapeHtml(s.category || 'Uncategorized')} ${price}</div>
            <p>${escapeHtml(s.description || '')}</p>
            <p><strong>Contact:</strong> ${escapeHtml(s.contact)}</p>
          </div>
        `;
      }).join('');
    }

    function escapeHtml(str='') {
      return String(str)
        .replaceAll('&','&amp;')
        .replaceAll('<','&lt;')
        .replaceAll('>','&gt;')
        .replaceAll('"','&quot;')
        .replaceAll("'","&#039;");
    }

    function uniqueCategories(rows) {
      const set = new Set();
      rows.forEach(r => { if (r.category) set.add(r.category.trim()); });
      return Array.from(set).sort((a,b)=>a.localeCompare(b));
    }

    function populateCategoryFilter(rows) {
      const cats = uniqueCategories(rows);
      categoryEl.innerHTML = `<option value="">All categories</option>` +
        cats.map(c => `<option value="${escapeHtml(c)}">${escapeHtml(c)}</option>`).join('');
    }

    function applyFilters() {
      const q = qEl.value.trim().toLowerCase();
      const cat = categoryEl.value.trim().toLowerCase();
      const sort = sortEl.value;

      let list = ALL.filter(s => {
        const matchesQ = !q || (
          (s.name||'').toLowerCase().includes(q) ||
          (s.category||'').toLowerCase().includes(q) ||
          (s.description||'').toLowerCase().includes(q)
        );
        const matchesCat = !cat || (s.category||'').toLowerCase() === cat;
        return matchesQ && matchesCat;
      });

      if (sort === 'name') {
        list.sort((a,b)=> (a.name||'').localeCompare(b.name||''));
      } else if (sort === 'category') {
        list.sort((a,b)=> (a.category||'').localeCompare(b.category||''));
      } else {
        // newest first assumes created_at exists
        list.sort((a,b)=> new Date(b.created_at||0) - new Date(a.created_at||0));
      }

      render(list);
    }

    // simple debounce so we don't over-render while typing
    function debounce(fn, ms=200) {
      let t; return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args), ms); };
    }

    async function load() {
      try {
        const { data, error } = await supabase
          .from('services')
          .select('id, name, category, description, price, contact, created_at');

        if (error) throw error;

        console.log('Fetched data:', data); // Debugging log to verify fetched data

        ALL = data || [];
        populateCategoryFilter(ALL);
        applyFilters();
      } catch (error) {
        console.error('Error fetching services:', error); // Debugging log for errors
        resultsEl.innerHTML = `<p class="error">Could not load services.</p>`;
      }
    }

    // Events
    qEl.addEventListener('input', debounce(applyFilters, 150));
    categoryEl.addEventListener('change', applyFilters);
    sortEl.addEventListener('change', applyFilters);

    // Kickoff
    load();
  </script>

  <label for="search-category">Filter by category:</label>
  <select id="search-category" name="search-category">
    <option value="">All Categories</option>
    <option value="Babysitting">Babysitting</option>
    <option value="Pet Care">Pet Care</option>
    <option value="Lawn Care">Lawn Care</option>
    <option value="Handyman">Handyman</option>
    <option value="Tutoring">Tutoring</option>
    <option value="Childcare">Childcare</option>
    <option value="Carpool">Carpool</option>
    <option value="Elderly Care">Elderly Care</option>
    <option value="Event Planning">Event Planning</option>
    <option value="Home Cleaning">Home Cleaning</option>
    <option value="Tech Support">Tech Support</option>
    <option value="Artisan Crafts">Artisan Crafts</option>
  </select>

  <script>
    document.getElementById("search-category").addEventListener("change", async (e) => {
      const selectedCategory = e.target.value;
      const container = document.getElementById("services");
      if (!container) return;

      container.innerHTML = "Loading…";

      // Fetch services from Supabase
      const { data, error } = await supabase
        .from("services")
        .select("id, name, category, description, price, contact, created_at")
        .order("created_at", { ascending: false });

      if (error) {
        console.error(error);
        container.innerHTML = "<p>Could not load services.</p>";
        return;
      }

      const filteredData = selectedCategory
        ? data.filter((svc) => svc.category === selectedCategory)
        : data;

      if (!filteredData || filteredData.length === 0) {
        container.innerHTML = "<p>No services found.</p>";
        return;
      }

      container.innerHTML = "";
      filteredData.forEach((svc) => {
        const card = document.createElement("div");
        card.className = "service-card";
        const priceRow = svc.price
          ? `<p class=\"service-meta\">Price: ${escapeHtml(svc.price)}</p>`
          : "";
        const contactRow = svc.contact
          ? `<p class=\"service-meta\">Contact: ${escapeHtml(svc.contact)}</p>`
          : "";
        card.innerHTML = `
          <h3>${escapeHtml(svc.category)}</h3>
          <p>${escapeHtml(svc.description)}</p>
          ${priceRow}
          <p class=\"service-meta\">Offered by: ${escapeHtml(svc.name)}</p>
          ${contactRow}
        `;
        container.appendChild(card);
      });
    });
  </script>
</body>
</html>